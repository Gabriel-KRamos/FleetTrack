{% load static %}
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciamento de Ve√≠culos</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/dashboard.css' %}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
</head>
<body>
    <div class="dashboard-container">
        <header class="page-header">
            <div class="header-info">
                <h1>Gerenciamento de Ve√≠culos</h1>
                <p>Monitore e gerencie os ve√≠culos da sua frota</p>
            </div>
            <a href="{% url 'dashboard' %}" class="btn btn-secondary">‚Üê Voltar ao Dashboard</a>
        </header>

        {% if messages %}
        <div class="messages" style="margin-bottom: 1.5rem;">
            {% for message in messages %}
            <div class="alert {% if message.tags == 'error' %}alert-error{% elif message.tags == 'success' %}alert-success{% else %}alert-{{ message.tags }}{% endif %}">{{ message }}</div>
            {% endfor %}
        </div>
        {% endif %}

        <section class="new-stat-cards">
            <div class="new-stat-card">
                <div class="new-stat-icon icon-total">üöó</div>
                <div class="new-stat-info">
                    <span class="value">{{ stats.total }}</span>
                    <span class="title">Total de Ve√≠culos</span>
                </div>
            </div>
            <div class="new-stat-card">
                <div class="new-stat-icon icon-available">‚úÖ</div>
                <div class="new-stat-info">
                    <span class="value">{{ stats.available }}</span>
                    <span class="title">Dispon√≠veis</span>
                </div>
            </div>
            <div class="new-stat-card">
                <div class="new-stat-icon icon-on-route">„Ä∞Ô∏è</div>
                <div class="new-stat-info">
                    <span class="value">{{ stats.on_route }}</span>
                    <span class="title">Em Rota</span>
                </div>
            </div>
            <div class="new-stat-card">
                <div class="new-stat-icon icon-maintenance">üõ†Ô∏è</div>
                <div class="new-stat-info">
                    <span class="value">{{ stats.maintenance }}</span>
                    <span class="title">Em Manuten√ß√£o</span>
                </div>
            </div>
            <div class="new-stat-card">
                <div class="new-stat-icon icon-disabled">‚ùå</div>
                <div class="new-stat-info">
                    <span class="value">{{ stats.disabled }}</span>
                    <span class="title">Desativados</span>
                </div>
            </div>
        </section>

        <main class="dashboard-content">
            <section class="card">
                <div class="table-header">
                    <h2>Frota de Ve√≠culos</h2>
                    <button class="btn btn-primary" id="open-add-vehicle-modal">+ Adicionar Ve√≠culo</button>
                </div>

                <form method="get" class="filter-bar">
                    <div class="search-container">
                        <input type="text" name="search" class="search-input" placeholder="Buscar por placa, modelo, motorista..." value="{{ search_query }}">
                    </div>
                    <select name="status" class="status-filter" onchange="this.form.submit()">
                        <option value="">Todos os Status</option>
                        {% for value, display in status_choices %}
                            <option value="{{ value }}" {% if value == status_filter %}selected{% endif %}>{{ display }}</option>
                            {% endfor %}
                    </select>
                </form>

                <div class="table-wrapper">
                    <table class="vehicle-table">
                        <thead>
                            <tr>
                                <th>Placa</th>
                                <th>Modelo</th>
                                <th>Ano</th>
                                <th>Status</th>
                                <th>Motorista</th>
                                <th>Quilometragem</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for vehicle in vehicles %}
                            {% with driver_on_route=vehicle.current_route_driver %}
                            <tr data-pk="{{ vehicle.pk }}"
                                data-plate="{{ vehicle.plate }}"
                                data-model="{{ vehicle.model }}"
                                data-year="{{ vehicle.year }}"
                                data-mileage="{{ vehicle.initial_mileage }}"
                                data-status="{{ vehicle.dynamic_status_slug }}"
                                data-status_display="{{ vehicle.dynamic_status }}"
                                data-driver_name="{{ driver_on_route.full_name|default:'N√£o atribu√≠do' }}"
                                data-acquisition_date="{{ vehicle.acquisition_date|date:'Y-m-d' }}"
                                data-average_fuel_consumption="{{ vehicle.average_fuel_consumption|default:'' }}">
                                
                                <td><span class="vehicle-icon">üöó</span> {{ vehicle.plate }}</td>
                                <td>{{ vehicle.model }}</td>
                                <td>{{ vehicle.year }}</td>

                                <td><span class="status-tag status-{{ vehicle.dynamic_status_slug }}">{{ vehicle.dynamic_status }}</span></td>

                                <td>
                                    {% if driver_on_route %}
                                        {{ driver_on_route.full_name }}
                                    {% else %}
                                        N√£o atribu√≠do
                                    {% endif %}
                                </td>
                                <td>{{ vehicle.mileage }} km</td>

                                <td class="actions">
                                    <a href="#" class="action-view action-link" title="Ver Detalhes">üëÅÔ∏è Ver</a>

                                    {% if vehicle.status != 'disabled' %}
                                        <a href="#" class="action-edit action-link" title="Editar">‚úèÔ∏è Editar</a>
                                        <a href="#" class="action-delete action-link" title="Desativar">üóëÔ∏è Desativar</a>
                                    {% else %}
                                        <form method="POST" action="{% url 'vehicle-reactivate' vehicle.pk %}" style="display: inline;">
                                            {% csrf_token %}
                                            <button type="submit" class="action-link" style="background:none; border:none; color:var(--success-color); cursor:pointer; padding:0; font-family: inherit; font-size: inherit; font-weight: 500;">‚Üª Reativar</button>
                                        </form>
                                    {% endif %}
                                </td>
                                </tr>
                            {% endwith %}
                            {% empty %}
                            <tr><td colspan="7" style="text-align: center; padding: 2rem;">Nenhum ve√≠culo encontrado.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </section>
        </main>
    </div>

    <div class="modal-overlay" id="add-vehicle-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="vehicle-modal-title">Adicionar Novo Ve√≠culo</h2>
                <button class="close-modal">&times;</button>
            </div>
            <form method="post" id="vehicle-form" class="modal-form">
                {% csrf_token %}
                {{ add_form.as_p }}
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary close-modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary" id="vehicle-submit-button">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal-overlay" id="deactivate-vehicle-modal">
        <div class="modal-content" style="max-width: 450px;">
            <div class="modal-header">
                <h2>Desativar Ve√≠culo</h2>
                <button class="close-modal">&times;</button>
            </div>
            <form method="post" id="deactivate-form">
                {% csrf_token %}
                <p>Voc√™ tem certeza que deseja desativar este ve√≠culo?</p>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary close-modal">Cancelar</button>
                    <button type="submit" class="btn btn-danger">Sim, Desativar</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal-overlay" id="vehicle-details-modal">
        <div class="modal-content details-modal" style="max-width: 600px;">
            <div class="modal-header">
                <div class="details-header-info">
                    <span class="details-icon" style="font-size: 1.5rem;">üöö</span>
                    <div>
                        <h2 id="details-plate"></h2>
                        <p id="details-model-year"></p>
                    </div>
                </div>
                <button class="close-modal">&times;</button>
            </div>

            <div class="modal-tab-nav">
                <a href="#" class="modal-tab-link active" data-target="tab-panel-details">Detalhes</a>
                <a href="#" class="modal-tab-link" data-target="tab-panel-maintenance">Hist. Manuten√ß√£o</a>
                <a href="#" class="modal-tab-link" data-target="tab-panel-routes">Hist. Rotas</a>
            </div>

            <div class="modal-tab-panel" id="tab-panel-details">
                <div class="details-section">
                    <h4>Status Atual</h4>
                    <p><span id="details-status-tag" class="status-tag"></span></p>
                </div>
                <div class="details-section">
                    <h4>Informa√ß√µes do Ve√≠culo</h4>
                    <div class="info-grid">
                        <div class="info-item"><small>Modelo</small><strong id="details-model"></strong></div>
                        <div class="info-item"><small>Ano</small><strong id="details-year"></strong></div>
                        <div class="info-item"><small>Quilometragem Inicial</small><strong id="details-mileage"></strong></div>
                        <div class="info-item"><small>Data de Aquisi√ß√£o</small><strong id="details-acquisition-date"></strong></div>
                        <div class="info-item">
                            <small>Consumo M√©dio (Km/L)</small>
                            <strong id="details-avg-consumption"></strong>
                        </div>
                    </div>
                </div>
                <div class="details-section">
                    <h4>Motorista Designado</h4>
                    <p id="details-driver-name" style="margin: 0; font-weight: 600;"></p>
                </div>
            </div>

            <div class="modal-tab-panel" id="tab-panel-maintenance" style="display: none;">
                <p class="history-loading">Carregando hist√≥rico...</p>
            </div>

            <div class="modal-tab-panel" id="tab-panel-routes" style="display: none;">
                <p class="history-loading">Carregando hist√≥rico...</p>
            </div>

            <div class="modal-footer" style="margin-top: 1.5rem;">
                <button type="button" class="btn btn-secondary close-modal">Fechar</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://npmcdn.com/flatpickr/dist/l10n/pt.js"></script>
    <script src="{% static 'js/vehicles.js' %}"></script>
</body>
</html>