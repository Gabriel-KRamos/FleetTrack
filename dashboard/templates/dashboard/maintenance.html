{% load static %}
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciamento de Manuten√ß√µes</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/dashboard.css' %}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
</head>
<body>
    <div class="dashboard-container">
        <header class="page-header">
            <div class="header-info">
                <h1>Gerenciamento de Manuten√ß√µes</h1>
                <p>Agende e acompanhe as manuten√ß√µes dos ve√≠culos</p>
            </div>
            <a href="{% url 'dashboard' %}" class="btn btn-secondary">‚Üê Voltar ao Dashboard</a>
        </header>

        {% if messages %}
        <div class="messages" style="margin-bottom: 1.5rem;">
            {% for message in messages %}
            <div class="alert {% if message.tags == 'error' %}alert-error{% elif message.tags == 'success' %}alert-success{% else %}alert-{{ message.tags }}{% endif %}">{{ message }}</div>
            {% endfor %}
        </div>
        {% endif %}

        <section class="new-stat-cards cols-4">
            <div class="new-stat-card"><div class="new-stat-icon icon-total">üõ†Ô∏è</div><div class="new-stat-info"><span class="value">{{ stats.total }}</span><span class="title">Total de Registros</span></div></div>
            <div class="new-stat-card"><div class="new-stat-icon icon-maintenance">üìÖ</div><div class="new-stat-info"><span class="value">{{ stats.scheduled }}</span><span class="title">Agendadas</span></div></div>
            <div class="new-stat-card"><div class="new-stat-icon icon-on-route">‚öôÔ∏è</div><div class="new-stat-info"><span class="value">{{ stats.in_progress }}</span><span class="title">Em Andamento</span></div></div>
            <div class="new-stat-card"><div class="new-stat-icon icon-available">‚úÖ</div><div class="new-stat-info"><span class="value">{{ stats.completed }}</span><span class="title">Conclu√≠das</span></div></div>
        </section>

        <main class="dashboard-content">
            <section class="card">
                <div class="table-header">
                    <h2>Registros de Manuten√ß√£o</h2>
                    <button class="btn btn-primary" id="open-add-maintenance-modal">+ Adicionar Manuten√ß√£o</button>
                </div>
                <form method="get" class="filter-bar">
                    <div class="search-container"><input type="text" name="search" class="search-input" placeholder="Buscar por ve√≠culo, tipo, mec√¢nica..." value="{{ search_query }}"></div>
                    <select name="status" class="status-filter" onchange="this.form.submit()">
                        <option value="">Todos os Status</option>
                        {% for value, display in status_choices %}<option value="{{ value }}" {% if value == status_filter %}selected{% endif %}>{{ display }}</option>{% endfor %}
                    </select>
                </form>
                <div class="table-wrapper">
                    <table class="vehicle-table">
                        <thead>
                            <tr><th>Ve√≠culo</th><th>Tipo de Manuten√ß√£o</th><th>Data Agendada</th><th>Status</th><th>Mec√¢nica</th><th>Custo (Est.)</th><th>A√ß√µes</th></tr>
                        </thead>
                        <tbody>
                            {% for m in maintenances %}
                            <tr data-pk="{{ m.pk }}"
                                data-vehicle_id="{{ m.vehicle.pk }}"
                                data-service_type="{{ m.service_type }}"
                                data-start_date="{{ m.start_date|date:'d/m/Y H:i' }}"
                                data-end_date="{{ m.end_date|date:'d/m/Y H:i' }}"
                                data-mechanic_shop_name="{{ m.mechanic_shop_name }}"
                                data-estimated_cost="{{ m.estimated_cost|default:'' }}"
                                data-current_mileage="{{ m.current_mileage }}"
                                data-notes="{{ m.notes|default:'' }}"
                                data-status="{{ m.status }}">
                                <td>{{ m.vehicle.plate }}</td>
                                <td>{{ m.service_type }}</td>
                                <td>{{ m.start_date|date:"d/m/Y" }}</td> 
                                <td><span class="status-tag status-{{ m.dynamic_status_slug }}">{{ m.dynamic_status }}</span></td>
                                <td>{{ m.mechanic_shop_name }}</td>
                                <td>R$ {{ m.estimated_cost|default:'--' }}</td>
                                <td class="actions">
                                    {% if m.status != 'completed' and m.status != 'canceled' %}
                                        <a href="#" class="action-complete action-link" title="Concluir">‚úì Concluir</a>
                                        <a href="#" class="action-edit action-link" title="Editar">‚úèÔ∏è Editar</a>
                                        <a href="#" class="action-cancel action-link" title="Cancelar">‚ùå Cancelar</a>
                                    {% else %}
                                        <span>--</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% empty %}
                            <tr><td colspan="7" style="text-align: center; padding: 2rem;">Nenhum registro de manuten√ß√£o encontrado.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </section>
        </main>
    </div>

    <div class="modal-overlay" id="maintenance-modal">
        <div class="modal-content">
            <div class="modal-header"><h2 id="maintenance-modal-title">Adicionar Manuten√ß√£o</h2><button class="close-modal">&times;</button></div>
            <form method="post" id="maintenance-form" class="modal-form">
                {% csrf_token %}
                <div class="modal-form-grid">
                    
                    <div class="form-group span-2">
                        <label for="id_vehicle">Ve√≠culo</label>
                        <select name="vehicle" id="id_vehicle" required>
                            <option value="">---------</option>
                            {% for vehicle in all_active_vehicles %}
                                <option value="{{ vehicle.pk }}" data-mileage="{{ vehicle.mileage }}">
                                    {{ vehicle.plate }} - {{ vehicle.model }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="form-group span-2">{{ add_form.service_type.label_tag }}{{ add_form.service_type }}</div>
                    <div class="form-group">{{ add_form.start_date.label_tag }}{{ add_form.start_date }}</div>
                    <div class="form-group">{{ add_form.end_date.label_tag }}{{ add_form.end_date }}</div>
                    <div class="form-group span-2">{{ add_form.mechanic_shop_name.label_tag }}{{ add_form.mechanic_shop_name }}</div>
                    <div class="form-group">{{ add_form.estimated_cost.label_tag }}{{ add_form.estimated_cost }}</div>

                    <div class_ ="form-group">
                        <p style="font-size: 1.0rem; font-weight: 500; margin: 0; padding-top: 10px; color: var(--text-secondary-color);">
                            Quilometragem Atual: 
                            <span id="mileage-display-value" style="font-weight: 600; color: var(--text-color);">-- selecione --</span>
                        </p>
                    </div>
                    
                    {{ add_form.current_mileage }}

                    <div class="form-group span-2">{{ add_form.notes.label_tag }}{{ add_form.notes }}</div>
                </div>
                <div class="modal-footer"><button type="button" class="btn btn-secondary close-modal">Cancelar</button><button type="submit" class="btn btn-primary">Salvar</button></div>
            </form>
        </div>
    </div>

    <div class="modal-overlay" id="complete-maintenance-modal">
        <div class="modal-content" style="max-width: 480px;">
            <div class="modal-header"><h2>Concluir Manuten√ß√£o</h2><button class="close-modal">&times;</button></div>
            <form method="post" id="complete-maintenance-form" class="modal-form">
                {% csrf_token %}
                <p>Confirme os dados de finaliza√ß√£o do servi√ßo.</p>
                <div class="form-group">{{ completion_form.actual_cost.label_tag }}{{ completion_form.actual_cost }}</div>
                <div class="form-group">{{ completion_form.actual_end_date.label_tag }}{{ completion_form.actual_end_date }}</div>
                <div class="modal-footer"><button type="button" class="btn btn-secondary close-modal">Voltar</button><button type="submit" class="btn btn-success">Confirmar Conclus√£o</button></div>
            </form>
        </div>
    </div>

    <div class="modal-overlay" id="cancel-maintenance-modal">
        <div class="modal-content" style="max-width: 450px;">
            <div class="modal-header"><h2>Cancelar Manuten√ß√£o</h2><button class="close-modal">&times;</button></div>
            <form method="post" id="cancel-maintenance-form"> 
                {% csrf_token %}
                <p>Tem certeza que deseja cancelar este registro de manuten√ß√£o? Esta a√ß√£o n√£o pode ser desfeita.</p>
                <div class="modal-footer"><button type="button" class="btn btn-secondary close-modal">N√£o</button><button type="submit" class="btn btn-danger">Sim, Cancelar</button></div>
            </form>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://npmcdn.com/flatpickr/dist/l10n/pt.js"></script>
    <script src="{% static 'js/maintenance.js' %}"></script>
</body>
</html>